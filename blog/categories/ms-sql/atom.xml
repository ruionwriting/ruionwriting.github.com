<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: MS SQL | RuiOnWriting.NET]]></title>
  <link href="http://ruionwriting.net/blog/categories/ms-sql/atom.xml" rel="self"/>
  <link href="http://ruionwriting.net/"/>
  <updated>2014-07-10T18:24:14+01:00</updated>
  <id>http://ruionwriting.net/</id>
  <author>
    <name><![CDATA[Rui Marques]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[SQL Server: how to crawl all databases for data]]></title>
    <link href="http://ruionwriting.net/blog/2014/04/21/sql-server-how-to-crawl-all-databases-for-data/"/>
    <updated>2014-04-21T21:23:00+01:00</updated>
    <id>http://ruionwriting.net/blog/2014/04/21/sql-server-how-to-crawl-all-databases-for-data</id>
    <content type="html"><![CDATA[<p>Some weeks back I was challenged to figure out a way to easily, and without killing the server, track the location of some string data on all databases on a certain server. This is the result. (Btw, I’m not a DBA and this may not be the most optimal solution). Worked without any damage and gave the expected results.</p>

<p>In the last 3 years SQL Server has been around on my regular developer life but not with too much challenges. MySql, Sqlite3, etc is also also part of the fun but I tend to forget some stuff. This is reminder.
<!--more--></p>

<h2 id="problem">Problem</h2>

<ul>
  <li>I want to search across dozens of database on a specific server;</li>
  <li>I need to search for a string in a predefined and limited number of potential column names. Why limited? Because string search with <em>LIKE</em> is an expensive operation. In my scenario I was dealing with big databases (both in terms of data and number of table objects).</li>
</ul>

<h2 id="plan">Plan</h2>

<ul>
  <li>Get a list of databases with the possibility of excluding some system databases;</li>
  <li>For each database get a list of all user tables;</li>
  <li>Get the list of columns for each table, with the potential column name;</li>
  <li>Apply a search of each found columns;</li>
  <li>Output the database, table and column names for every match.</li>
</ul>

<p>Sound simple…</p>

<h2 id="solution">Solution</h2>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Full script </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="err">–</span> <span class="n">selecting</span> <span class="n">master</span> <span class="k">database</span>
</span><span class='line'><span class="n">USE</span> <span class="n">master</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpTables</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">TableName</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">TableId</span>       <span class="nb">INT</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpColumns</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">ColumnName</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpSearchStrings</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">id</span> <span class="nb">int</span> <span class="k">identity</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span class='line'>    <span class="n">SearchString</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">DECLARE</span> <span class="o">@</span><span class="n">Splited</span> <span class="k">TABLE</span><span class="p">(</span><span class="n">id</span> <span class="nb">INT</span> <span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">item</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">DECLARE</span>
</span><span class='line'>    <span class="o">@</span><span class="n">db_name</span>        <span class="n">SYSNAME</span><span class="p">,</span>
</span><span class='line'>    <span class="o">@</span><span class="n">db_id</span>          <span class="nb">INT</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
</span><span class='line'>    <span class="o">@</span><span class="n">cmd</span>            <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span>
</span><span class='line'>    <span class="o">@</span><span class="n">search_string</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span>
</span><span class='line'>    <span class="o">@</span><span class="n">column_filter</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span>
</span><span class='line'>    <span class="o">@</span><span class="k">table_name</span>     <span class="n">SYSNAME</span><span class="p">,</span>
</span><span class='line'>    <span class="o">@</span><span class="n">table_id</span>       <span class="nb">INT</span><span class="p">,</span>
</span><span class='line'>    <span class="o">@</span><span class="k">column_name</span>    <span class="n">SYSNAME</span><span class="p">,</span>
</span><span class='line'>    <span class="o">@</span><span class="n">sql_string</span>     <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span>
</span><span class='line'>    <span class="o">@</span><span class="n">sql_like_expr</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="n">init</span> <span class="k">search</span> <span class="n">string</span> <span class="k">with</span> <span class="k">search</span> <span class="n">terms</span> <span class="p">(</span><span class="n">comma</span> <span class="n">separated</span> <span class="k">for</span> <span class="n">multiple</span><span class="p">)</span>
</span><span class='line'><span class="k">SET</span> <span class="o">@</span><span class="n">search_string</span> <span class="o">=</span> <span class="err">‘</span><span class="n">bill</span><span class="o">@</span><span class="n">microsoft</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="n">bgates</span><span class="o">@</span><span class="n">microsoft</span><span class="p">.</span><span class="n">com</span><span class="err">’</span>
</span><span class='line'><span class="k">SET</span> <span class="o">@</span><span class="n">search_string</span> <span class="o">=</span> <span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">search_string</span><span class="p">,</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">,</span><span class="err">’’’</span> <span class="k">UNION</span> <span class="k">ALL</span> <span class="k">SELECT</span> <span class="err">‘’’</span><span class="p">)</span>
</span><span class='line'><span class="k">SET</span> <span class="o">@</span><span class="n">search_string</span> <span class="o">=</span> <span class="err">‘</span> <span class="k">SELECT</span>  <span class="err">‘’’</span><span class="o">+</span> <span class="o">@</span><span class="n">search_string</span><span class="o">+</span><span class="err">’’’</span>  <span class="err">‘</span> <span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">tmpSearchStrings</span>
</span><span class='line'><span class="k">EXEC</span><span class="p">(</span><span class="o">@</span><span class="n">search_string</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="n">crawl</span> <span class="k">only</span> <span class="n">tables</span> <span class="k">with</span> <span class="err">‘</span><span class="n">mail</span><span class="err">’</span> <span class="n">has</span> <span class="n">being</span> <span class="n">part</span> <span class="k">of</span> <span class="n">their</span> <span class="n">name</span>
</span><span class='line'><span class="k">SET</span> <span class="o">@</span><span class="n">column_filter</span> <span class="o">=</span> <span class="err">‘</span><span class="o">%</span><span class="n">mail</span><span class="o">%</span><span class="err">’</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="n">init</span> <span class="n">the</span> <span class="n">main</span> <span class="k">cursor</span> <span class="n">that</span> <span class="k">with</span> <span class="k">cycle</span> <span class="n">across</span> <span class="k">all</span> <span class="n">databases</span>
</span><span class='line'><span class="err">–</span> <span class="n">note</span> <span class="err">‘</span><span class="n">database_id</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">4</span><span class="err">’</span> <span class="k">is</span> <span class="n">used</span> <span class="k">to</span> <span class="n">exclude</span> <span class="k">system</span> <span class="n">databases</span>
</span><span class='line'><span class="k">DECLARE</span> <span class="n">db_cur</span> <span class="k">CURSOR</span> <span class="k">FOR</span> <span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">database_id</span> <span class="k">FROM</span> <span class="n">SYS</span><span class="p">.</span><span class="n">databases</span> <span class="k">WHERE</span> <span class="n">database_id</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">4</span> <span class="k">AND</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">NOT</span> <span class="k">LIKE</span> <span class="err">‘</span><span class="o">%</span><span class="n">some_other_database_to_exclude</span><span class="o">%</span><span class="err">’</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">name</span> <span class="k">ASC</span>
</span><span class='line'><span class="k">OPEN</span> <span class="n">db_cur</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">db_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">db_name</span><span class="p">,</span> <span class="o">@</span><span class="n">db_id</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">WHILE</span> <span class="p">(</span><span class="o">@@</span><span class="n">FETCH_STATUS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="k">BEGIN</span>   <span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="c1">-- build query for finding tables for the current database</span>
</span><span class='line'><span class="k">SET</span> <span class="o">@</span><span class="n">sql_string</span> <span class="o">=</span> <span class="s1">&#39;SELECT name AS TableName, object_id AS TableId FROM [&#39;</span> <span class="o">+</span> <span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">,</span> <span class="o">@</span><span class="n">db_name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;].sys.tables&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">tmpTables</span>
</span><span class='line'>    <span class="k">EXECUTE</span><span class="p">(</span><span class="o">@</span><span class="n">sql_string</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- init the tables cursor to cycle through current database tables</span>
</span><span class='line'><span class="k">DECLARE</span> <span class="n">tables_cur</span> <span class="k">CURSOR</span> <span class="k">FOR</span> <span class="k">SELECT</span> <span class="n">TableName</span><span class="p">,</span> <span class="n">TableId</span> <span class="k">FROM</span> <span class="o">#</span><span class="n">tmpTables</span>
</span><span class='line'><span class="k">OPEN</span> <span class="n">tables_cur</span>
</span><span class='line'>
</span><span class='line'><span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">tables_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="k">table_name</span><span class="p">,</span> <span class="o">@</span><span class="n">table_id</span>
</span><span class='line'>
</span><span class='line'><span class="n">WHILE</span> <span class="p">(</span><span class="o">@@</span><span class="n">FETCH_STATUS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="k">BEGIN</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- build query for finding desired columns within current table</span>
</span><span class='line'>    <span class="k">SET</span> <span class="o">@</span><span class="n">sql_string</span> <span class="o">=</span> <span class="s1">&#39;SELECT COLUMN_NAME as ColumnName From &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">db_name</span> <span class="o">+</span> <span class="s1">&#39;.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = &#39;&#39;&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="k">table_name</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39; AND COLUMN_NAME LIKE &#39;&#39;&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">column_filter</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">tmpColumns</span>
</span><span class='line'>        <span class="k">EXECUTE</span><span class="p">(</span><span class="o">@</span><span class="n">sql_string</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- init the columns cursor to cycle through current matching columns</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">columns_cur</span> <span class="k">CURSOR</span> <span class="k">FOR</span> <span class="k">SELECT</span> <span class="n">ColumnName</span> <span class="k">FROM</span> <span class="o">#</span><span class="n">tmpColumns</span>
</span><span class='line'>    <span class="k">OPEN</span> <span class="n">columns_cur</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">columns_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="k">column_name</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">WHILE</span> <span class="p">(</span><span class="o">@@</span><span class="n">FETCH_STATUS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">BEGIN</span>
</span><span class='line'>        <span class="k">SET</span> <span class="o">@</span><span class="n">sql_like_expr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">-- init cursor to cycle through search string for current column</span>
</span><span class='line'>        <span class="k">DECLARE</span> <span class="n">expr_cur</span> <span class="k">CURSOR</span> <span class="k">FOR</span> <span class="k">SELECT</span> <span class="n">SearchString</span> <span class="k">FROM</span> <span class="o">#</span><span class="n">tmpSearchStrings</span>
</span><span class='line'>        <span class="k">OPEN</span> <span class="n">expr_cur</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">expr_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">search_string</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">WHILE</span> <span class="p">(</span><span class="o">@@</span><span class="n">FETCH_STATUS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">BEGIN</span>
</span><span class='line'>            <span class="c1">-- build search query expr with output if results are found</span>
</span><span class='line'>            <span class="k">SET</span> <span class="o">@</span><span class="n">sql_string</span> <span class="o">=</span> <span class="s1">&#39;IF EXISTS (SELECT * FROM [&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">db_name</span> <span class="o">+</span> <span class="s1">&#39;].[dbo].[&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="k">table_name</span> <span class="o">+</span> <span class="s1">&#39;] WHERE [&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="k">column_name</span> <span class="o">+</span> <span class="s1">&#39;] LIKE &#39;&#39;%&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">search_string</span> <span class="o">+</span> <span class="s1">&#39;%&#39;&#39;) PRINT &#39;&#39;&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">db_name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="k">table_name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="k">column_name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">search_string</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;&#39;</span>
</span><span class='line'>            <span class="k">EXECUTE</span><span class="p">(</span><span class="o">@</span><span class="n">sql_string</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">expr_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">search_string</span>
</span><span class='line'>        <span class="k">END</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">CLOSE</span> <span class="n">expr_cur</span>
</span><span class='line'>        <span class="k">DEALLOCATE</span> <span class="n">expr_cur</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">columns_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="k">column_name</span>
</span><span class='line'>    <span class="k">END</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">CLOSE</span> <span class="n">columns_cur</span>
</span><span class='line'>    <span class="k">DEALLOCATE</span> <span class="n">columns_cur</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">DELETE</span> <span class="k">FROM</span> <span class="o">#</span><span class="n">tmpColumns</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">tables_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="k">table_name</span><span class="p">,</span> <span class="o">@</span><span class="n">table_id</span>
</span><span class='line'><span class="k">END</span>
</span><span class='line'>
</span><span class='line'><span class="k">CLOSE</span> <span class="n">tables_cur</span>
</span><span class='line'><span class="k">DEALLOCATE</span> <span class="n">tables_cur</span>
</span><span class='line'>
</span><span class='line'><span class="k">DELETE</span> <span class="k">FROM</span> <span class="o">#</span><span class="n">tmpTables</span>
</span><span class='line'>
</span><span class='line'><span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">db_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">db_name</span><span class="p">,</span> <span class="o">@</span><span class="n">db_id</span> <span class="k">END</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="k">close</span> <span class="k">and</span> <span class="k">deallocate</span> <span class="n">databases</span> <span class="n">cursos</span>
</span><span class='line'><span class="k">CLOSE</span> <span class="n">db_cur</span>
</span><span class='line'><span class="k">DEALLOCATE</span> <span class="n">db_cur</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="k">drop</span> <span class="n">temp</span> <span class="n">tables</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpTables</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpColumns</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpSearchStrings</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>I’ve used mainly cursors. If you are not very familiarized with it check the <a href="http://technet.microsoft.com/en-us/library/ms180169.aspx">official documentation</a> or this nice <a href="http://www.mssqltips.com/sqlservertip/1599/sql-server-cursor-example/">example</a>.</p>

<p>I hope you may found this useful.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SQL Server: (re)import CSV data the easy way]]></title>
    <link href="http://ruionwriting.net/blog/2014/04/12/sql-server-re-import-csv-data-the-easy-way/"/>
    <updated>2014-04-12T19:31:00+01:00</updated>
    <id>http://ruionwriting.net/blog/2014/04/12/sql-server-re-import-csv-data-the-easy-way</id>
    <content type="html"><![CDATA[<p>Importing data into SQL Server is not hard using the import data feature but I really don’t appreciate the fact that there is no way to save that import profile/rules for later reuse. Solution: use BULK INSERT from a regular reusable sql script.</p>

<p><a href="http://technet.microsoft.com/en-us/library/ms188365.aspx">BULK INSERT (Transact-SQL)</a> is a really nice feature that allows to easily create a reusable data import script capable of import one or many CSV files. I’m going to build a simple script using this nice feature.
<!--more--></p>

<p>For this example I have a simple CSV file containing a set of data from a fictional marketing contacts database.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Example CSV source </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Id;Name;EmailAddress;MobileNumber
</span><span class='line'>1;John;john@gmail.com;123456789
</span><span class='line'>2;Mary;mary@gmail.com;123456789
</span><span class='line'>…</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>In order to use BULK INSERT I need the target table structure to have the same structure as the source data. Not always this would be the case so I’m going to create a temporary table to hold my source data that will be retrieved from the BULK INSERT.</p>

<p><strong>Creating the temporary table:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Temporary table to hold CSV data </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tempSource_Table_Name</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">Id</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>    <span class="p">[</span><span class="n">Name</span><span class="p">]</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
</span><span class='line'>    <span class="n">EmailAddress</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>    <span class="n">MobileNumber</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">null</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This temporary table columns definitions should reflect the source structure and columns types.</p>

<p>Now that I have a temporary table that can receive the source data from the CSV.</p>

<p><strong>Building the BULK INSERT script:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>BULK INSERT </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">BULK</span> <span class="k">INSERT</span> <span class="o">#</span><span class="n">tempSource_Table_Name</span>
</span><span class='line'><span class="k">FROM</span> <span class="err">‘</span><span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">csv_file_full_path</span><span class="err">\</span><span class="n">source_table_data</span><span class="p">.</span><span class="n">csv</span><span class="err">’</span>
</span><span class='line'><span class="k">WITH</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>    <span class="n">FIRSTROW</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>    <span class="n">FIELDTERMINATOR</span> <span class="o">=</span> <span class="err">‘</span><span class="p">;</span><span class="err">’</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ROWTERMINATOR</span> <span class="o">=</span> <span class="err">‘\</span><span class="n">n</span><span class="err">’</span><span class="p">,</span>
</span><span class='line'>    <span class="n">CODEPAGE</span> <span class="o">=</span> <span class="err">‘</span><span class="n">ACP</span><span class="err">’</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>I’m just applying a short set of the <a href="http://technet.microsoft.com/en-us/library/ms188365.aspx">available arguments</a>. Based on your data source apply the necessary arguments.</p>

<p>This is a very powerful tool. Just for the example, is possible to have a source data file from a UNC share, take control over encoding, etc.</p>

<p>Now that I have a temporary table containing the imported data I can insert it to my target table applying some extra import rules and tweaks.</p>

<p><strong>Building the insert script for the target table:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Insert data to target table  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Target_Table_Name</span><span class="p">]</span>
</span><span class='line'>   <span class="p">([</span><span class="n">Name</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">MobileNumber</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">EmailAddress</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">Password</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">LastKnownIPAddress</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">CreatedOn</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">ChangedOn</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">VerifiedOn</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">Blocked</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">BlockEmailMarketing</span><span class="p">])</span>
</span><span class='line'><span class="k">SELECT</span>
</span><span class='line'>    <span class="p">[</span><span class="n">Name</span><span class="p">]</span>
</span><span class='line'>    <span class="p">,[</span><span class="n">MobileNumber</span><span class="p">]</span>
</span><span class='line'>    <span class="p">,(</span>
</span><span class='line'>        <span class="k">CASE</span>
</span><span class='line'>            <span class="k">WHEN</span> <span class="p">[</span><span class="n">EmailAddress</span><span class="p">]</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>                <span class="k">THEN</span> <span class="n">CONCAT</span><span class="p">(</span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span> <span class="p">[</span><span class="n">Id</span><span class="p">]),</span> <span class="err">‘</span><span class="o">@</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>            <span class="k">ELSE</span> <span class="p">[</span><span class="n">EmailAddress</span><span class="p">]</span>
</span><span class='line'>        <span class="k">END</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="p">,</span><span class="k">NULL</span>
</span><span class='line'>    <span class="p">,</span><span class="k">NULL</span>
</span><span class='line'>    <span class="p">,(</span><span class="k">SELECT</span> <span class="n">GETDATE</span><span class="p">())</span>
</span><span class='line'>    <span class="p">,</span><span class="k">NULL</span>
</span><span class='line'>    <span class="p">,</span><span class="k">NULL</span>
</span><span class='line'>    <span class="p">,</span><span class="mi">0</span>
</span><span class='line'>    <span class="p">,</span><span class="mi">0</span>        <span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="k">FROM</span> <span class="o">#</span><span class="n">tempSource_Table_Name</span>
</span><span class='line'><span class="err">–</span> <span class="n">apply</span> <span class="k">any</span> <span class="n">addional</span> <span class="n">filtering</span><span class="o">/</span><span class="n">sorting</span> <span class="k">as</span> <span class="n">needed</span>
</span><span class='line'><span class="err">–</span> <span class="k">WHERE</span> <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class='line'><span class="err">–</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">EmailAddress</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This example shows that is quite easy to apply some data transformations to the source data before inserting it on my target table. All the power of Transact-SQL is available to make a serious import script using this strategy.</p>

<p><strong>Also I want to add to my import script some extra features:</strong></p>

<ul>
  <li>perform all my operations wrapped within a transaction;</li>
  <li>sanitize data before import (useful I want to test the import multiple times);</li>
  <li>demonstrate that is easy to import multiple files in one run.</li>
</ul>

<p><strong>Here the full script:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Complete script with comments  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="cm">/* </span>
</span><span class='line'><span class="cm">    set target database</span>
</span><span class='line'><span class="cm">*/</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">USE</span> <span class="p">[</span><span class="n">Target_Database_Name</span><span class="p">]</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/* </span>
</span><span class='line'><span class="cm">    wrap everything in a transaction </span>
</span><span class='line'><span class="cm">*/</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">BEGIN</span> <span class="n">TRAN</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/* </span>
</span><span class='line'><span class="cm">    (optional) sanitize target table(s)</span>
</span><span class='line'><span class="cm">*/</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="n">remove</span> <span class="k">all</span> <span class="k">rows</span>
</span><span class='line'><span class="k">DELETE</span> <span class="k">FROM</span> <span class="p">[</span><span class="n">Target_Table_Name</span><span class="p">];</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="n">if</span> <span class="n">your</span> <span class="n">the</span> <span class="n">target</span> <span class="k">table</span> <span class="k">contains</span> <span class="n">a</span> <span class="k">identity</span> <span class="k">key</span><span class="p">,</span> <span class="k">reset</span> <span class="n">its</span> <span class="n">value</span>
</span><span class='line'><span class="n">DBCC</span> <span class="n">CHECKIDENT</span> <span class="p">([</span><span class="n">Target_Table_Name</span><span class="p">],</span> <span class="n">reseed</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="n">extra</span> <span class="n">sanitization</span> <span class="n">operations</span> <span class="k">like</span> <span class="n">disabling</span> <span class="n">triggers</span><span class="p">,</span> <span class="n">FK</span><span class="err">’</span><span class="n">s</span><span class="p">,</span> <span class="n">etc</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/*</span>
</span><span class='line'><span class="cm">    creat a temp table, for each CSV that you wish to import, to hold CSV data&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">&lt;pre&gt;&lt;code&gt;example CSV:</span>
</span><span class='line'>
</span><span class='line'><span class="cm">Id;Name;EmailAddress;MobileNumber</span>
</span><span class='line'><span class="cm">1;John;john@gmail.com;123456789</span>
</span><span class='line'><span class="cm">2;Mary;mary@gmail.com;123456789</span>
</span><span class='line'>
</span><span class='line'><span class="cm">table structure and column types must match with the CSV */</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tempSource_Table_Name</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">Id</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>    <span class="p">[</span><span class="n">Name</span><span class="p">]</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
</span><span class='line'>    <span class="n">EmailAddress</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>    <span class="n">MobileNumber</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">null</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/*</span>
</span><span class='line'><span class="cm">    import CSV data to the temp table</span>
</span><span class='line'><span class="cm">*/</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">BULK</span> <span class="k">INSERT</span> <span class="o">#</span><span class="n">tempSource_Table_Name</span>
</span><span class='line'><span class="k">FROM</span> <span class="err">‘</span><span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">csv_file_full_path</span><span class="err">\</span><span class="n">source_table_data</span><span class="p">.</span><span class="n">csv</span><span class="err">’</span>
</span><span class='line'><span class="k">WITH</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>    <span class="n">FIRSTROW</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>    <span class="n">FIELDTERMINATOR</span> <span class="o">=</span> <span class="err">‘</span><span class="p">;</span><span class="err">’</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ROWTERMINATOR</span> <span class="o">=</span> <span class="err">‘\</span><span class="n">n</span><span class="err">’</span><span class="p">,</span>
</span><span class='line'>    <span class="n">CODEPAGE</span> <span class="o">=</span> <span class="err">‘</span><span class="n">ACP</span><span class="err">’</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/*</span>
</span><span class='line'><span class="cm">    insert data to the target table using temp table as the source</span>
</span><span class='line'><span class="cm">    apply as many rules as needed to transform imput data</span>
</span><span class='line'><span class="cm">*/</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Target_Table_Name</span><span class="p">]</span>
</span><span class='line'>   <span class="p">([</span><span class="n">Name</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">MobileNumber</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">EmailAddress</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">Password</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">LastKnownIPAddress</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">CreatedOn</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">ChangedOn</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">VerifiedOn</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">Blocked</span><span class="p">]</span>
</span><span class='line'>   <span class="p">,[</span><span class="n">BlockEmailMarketing</span><span class="p">])</span>
</span><span class='line'><span class="k">SELECT</span>
</span><span class='line'>    <span class="p">[</span><span class="n">Name</span><span class="p">]</span>
</span><span class='line'>    <span class="p">,[</span><span class="n">MobileNumber</span><span class="p">]</span>
</span><span class='line'>    <span class="p">,(</span>
</span><span class='line'>        <span class="k">CASE</span>
</span><span class='line'>            <span class="k">WHEN</span> <span class="p">[</span><span class="n">EmailAddress</span><span class="p">]</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>                <span class="k">THEN</span> <span class="n">CONCAT</span><span class="p">(</span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span> <span class="p">[</span><span class="n">Id</span><span class="p">]),</span> <span class="err">‘</span><span class="o">@</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>            <span class="k">ELSE</span> <span class="p">[</span><span class="n">EmailAddress</span><span class="p">]</span>
</span><span class='line'>        <span class="k">END</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="p">,</span><span class="k">NULL</span>
</span><span class='line'>    <span class="p">,</span><span class="k">NULL</span>
</span><span class='line'>    <span class="p">,(</span><span class="k">SELECT</span> <span class="n">GETDATE</span><span class="p">())</span>
</span><span class='line'>    <span class="p">,</span><span class="k">NULL</span>
</span><span class='line'>    <span class="p">,</span><span class="k">NULL</span>
</span><span class='line'>    <span class="p">,</span><span class="mi">0</span>
</span><span class='line'>    <span class="p">,</span><span class="mi">0</span>        <span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="k">FROM</span> <span class="o">#</span><span class="n">tempSource_Table_Name</span>
</span><span class='line'><span class="err">–</span> <span class="n">apply</span> <span class="k">any</span> <span class="n">addional</span> <span class="n">filtering</span><span class="o">/</span><span class="n">sorting</span> <span class="k">as</span> <span class="n">needed</span>
</span><span class='line'><span class="err">–</span> <span class="k">WHERE</span> <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class='line'><span class="err">–</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">EmailAddress</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/*</span>
</span><span class='line'><span class="cm">    drop temp table(s)</span>
</span><span class='line'><span class="cm">*/</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tempSource_Table_Name</span><span class="p">;</span>
</span><span class='line'><span class="k">GO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/* </span>
</span><span class='line'><span class="cm">    extra operations</span>
</span><span class='line'><span class="cm">*/</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">–</span> <span class="n">enable</span> <span class="n">triggers</span><span class="p">,</span> <span class="n">FK</span><span class="err">’</span><span class="n">s</span><span class="p">,</span> <span class="n">etc</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/*</span>
</span><span class='line'><span class="cm">    all good, time to commit transaction</span>
</span><span class='line'><span class="cm">*/</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">COMMIT</span> <span class="n">TRAN</span>
</span><span class='line'><span class="k">GO</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
</feed>
